{% extends "../partials/layout.njk" %}

{% from "../components/dataSource.njk" import dataSource %}

{% set graphTitle = "Behaviour entries in the last 28 days" %}
{% set pageTitle = applicationName + " â€“ " + graphTitle %}

{% block content %}
  <h1 class="govuk-heading-xl">
    {{ graphTitle }}
  </h1>

  <div class="govuk-grid-row">
    <section class="govuk-grid-column-one-half govuk-!-margin-bottom-9">

      <h2 class="govuk-heading-m">
        Comparison of positive and negative behaviour entries by wing
      </h2>

      {{ dataSource("NOMIS", lastUpdated, {"classes": "govuk-!-margin-bottom-6"}) }}

      <div>
        <a href="?" class="govuk-button govuk-button--secondary govuk-!-margin-right-6">Download chart</a>

        <div aria-hidden="true" class="app-chart-legend">
          <span class="app-chart-legend__swatch app-chart-colour--a">&nbsp;</span>
          <span class="app-chart-legend__label">Positive</span>
          <span class="app-chart-legend__swatch app-chart-colour--b">&nbsp;</span>
          <span class="app-chart-legend__label">Negative</span>
        </div>
      </div>

      <table class="app-chart-table app-chart-table--bars">
        <caption class="govuk-visually-hidden">
          Comparison of positive and negative behaviour entries by wing in the last 28 days
        </caption>

        <thead>
          <tr>
            <th scope="col">Location</th>
            <th scope="col">Positive <span class="govuk-visually-hidden">entries</span></th>
            <th scope="col">Negative <span class="govuk-visually-hidden">entries</span></th>
            <th aria-hidden="true" class="govuk-visually-hidden" scope="col">Chart</th>
          </tr>
        </thead>

        <tbody>
          {% for row in behaviourEntries %}
            {% set totalEntries = row.entriesPositive + row.entriesNegative %}
            {% set percentagePositive = row.entriesPositive | percentageOf(totalEntries) %}
            {% set percentageNegative = row.entriesNegative | percentageOf(totalEntries) %}

            <tr>
              <td>
                {% if row.href %}
                  <a href="{{ row.href }}">{{ row.location }}</a>
                {% else %}
                  {{ row.location }}
                {% endif %}
              </td>
              <td>
                {{ percentagePositive }}
                <br />
                {{ row.entriesPositive | thousands }} <span class="govuk-visually-hidden">entries</span>
              </td>
              <td>
                {{ percentageNegative }}
                <br />
                {{ row.entriesNegative | thousands}} <span class="govuk-visually-hidden">entries</span>
              </td>
              <td aria-hidden="true" class="app-chart-table__percentage-cell">
              <span class="app-chart-table__axis-midpoint"></span>
                <div id="c-pos-{{ loop.index }}" class="app-chart-table__percentage-cell-bar app-chart-colour--a">&nbsp;<br />&nbsp;</div>
                <div id="c-neg-{{ loop.index }}" class="app-chart-table__percentage-cell-bar app-chart-colour--b">&nbsp;<br />&nbsp;</div>
                <style nonce="{{ cspNonce }}">
                  #c-pos-{{ loop.index }} { width:{{ percentagePositive }}; }
                  #c-neg-{{ loop.index }} { width:{{ percentageNegative }}; }
                </style>
              </td>
            </tr>
          {% endfor %}
        </tbody>

        <tfoot aria-hidden="true">
          <tr>
            <td colspan="3"></td>
            <td class="app-chart-table__axis-values">
              <span class="app-chart-table__axis-midpoint"></span>
              <span class="app-chart-table__axis-value app-chart-table__axis-value--min">0</span>
              <span class="app-chart-table__axis-value app-chart-table__axis-value--mid">50</span>
              <span class="app-chart-table__axis-value app-chart-table__axis-value--max">100</span>
            </td>
          </tr>
          <tr>
            <td colspan="3"></td>
            <td>Percentage</td>
          </tr>
        </tfoot>
      </table>

    </section>
    <section class="govuk-grid-column-one-half govuk-!-margin-bottom-9">

      <h2 class="govuk-heading-m">
        Percentage and number of prisoners by behaviour entry on each wing
      </h2>

      {{ dataSource("NOMIS", lastUpdated, {"classes": "govuk-!-margin-bottom-6"}) }}

      {% macro heatMapClass(percentage) %}
        {%- if percentage < 15 -%}
          app-chart-colour--heat-0
        {%- elseif percentage < 30 -%}
          app-chart-colour--heat-15
        {%- elseif percentage < 45 -%}
          app-chart-colour--heat-30
        {%- elseif percentage < 60 -%}
          app-chart-colour--heat-45
        {%- elseif percentage < 75 -%}
          app-chart-colour--heat-60
        {%- elseif percentage < 90 -%}
          app-chart-colour--heat-75
        {%- else -%}
          app-chart-colour--heat-90
        {%- endif -%}
      {% endmacro %}

      <div>
        <a href="?" class="govuk-button govuk-button--secondary govuk-!-margin-right-6">Download heatmap</a>

        <div aria-hidden="true" class="app-chart-legend">
          <span class="app-chart-legend__label">100%</span>
          <span class="app-chart-legend__swatch {{ heatMapClass(100) }}">&nbsp;</span>
          <span class="app-chart-legend__swatch {{ heatMapClass(75) }}">&nbsp;</span>
          <span class="app-chart-legend__swatch {{ heatMapClass(60) }}">&nbsp;</span>
          <span class="app-chart-legend__swatch {{ heatMapClass(45) }}">&nbsp;</span>
          <span class="app-chart-legend__swatch {{ heatMapClass(30) }}">&nbsp;</span>
          <span class="app-chart-legend__swatch {{ heatMapClass(15) }}">&nbsp;</span>
          <span class="app-chart-legend__swatch {{ heatMapClass(0) }}">&nbsp;</span>
          <span class="app-chart-legend__label">0%</span>
        </div>
      </div>

      <table class="app-chart-table app-chart-table--heatmap">
        <caption class="govuk-visually-hidden">
          Percentage and number of prisoners by behaviour entry on each wing in the last 28 days
        </caption>

        <thead>
          <tr>
            <th scope="col">Location</th>
            <th scope="col" aria-label="Prisoners with positive entries">Positive</th>
            <th scope="col" aria-label="Prisoners with negative entries">Negative</th>
            <th scope="col" aria-label="Prisoners with both kinds of entries">Both</th>
            <th scope="col" aria-label="Prisoners with no positive or negative entries">None</th>
          </tr>
        </thead>

        <tbody>
          {% for row in prisonersWithEntries %}
            {% set totalPrisoners = row.prisonersWithPositive + row.prisonersWithNegative + row.prisonersWithBoth + row.prisonersWithNeither %}
            {% set percentagePositive = row.prisonersWithPositive | percentageOf(totalPrisoners) %}
            {% set percentageNegative = row.prisonersWithNegative | percentageOf(totalPrisoners) %}
            {% set percentageBoth = row.prisonersWithBoth | percentageOf(totalPrisoners) %}
            {% set percentageNeither = row.prisonersWithNeither | percentageOf(totalPrisoners) %}

            <tr>
              <td>
                {% if row.href %}
                  <a href="{{ row.href }}">{{ row.location }}</a>
                {% else %}
                  {{ row.location }}
                {% endif %}
              </td>
              <td>
                <span class="app-chart-table--heatmap__cell {{ heatMapClass(percentagePositive | float) }}">
                  {{ percentagePositive }}
                  <br />
                  {{ row.prisonersWithPositive | thousands }} <span class="govuk-visually-hidden">prisoners with positive entries</span>
                </span>
              </td>
              <td>
                <span class="app-chart-table--heatmap__cell {{ heatMapClass(percentageNegative | float) }}">
                  {{ percentageNegative }}
                  <br />
                  {{ row.prisonersWithNegative | thousands }} <span class="govuk-visually-hidden">prisoners with negative entries</span>
                </span>
              </td>
              <td>
                <span class="app-chart-table--heatmap__cell {{ heatMapClass(percentageBoth | float) }}">
                  {{ percentageBoth }}
                  <br />
                  {{ row.prisonersWithBoth | thousands }} <span class="govuk-visually-hidden">prisoners with both kinds of entries</span>
                </span>
              </td>
              <td>
                <span class="app-chart-table--heatmap__cell {{ heatMapClass(percentageNeither | float) }}">
                  {{ percentageNeither }}
                  <br />
                  {{ row.prisonersWithNeither | thousands }} <span class="govuk-visually-hidden">prisoners with no positive or negative entries</span>
                </span>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

    </section>
  </div>
{% endblock %}
