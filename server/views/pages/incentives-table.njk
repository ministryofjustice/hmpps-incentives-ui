{% extends "../partials/layout.njk" %}

{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/tabs/macro.njk" import govukTabs %}

{% set pageTitle = applicationName + " - Home" %}

{% block content %}

  <main class="app-container govuk-body govuk-width-container">
    <h1 class="govuk-heading-xl govuk-!-margin-bottom-4">
        {{ entries.locationDescription }} incentive information
    </h1>

    <p>
        <a href="/select-location" class="govuk-link">Select another location</a>
    </p>

    <div class="govuk-grid-row govuk-!-margin-top-8 govuk-grid-row">
        <div class="govuk-grid-column-full">
            <h2 class="govuk-heading-l">Incentive levels</h2>
        </div>
        {% for level in entries.incentiveLevelSummary %}
            <div class="govuk-grid-column-one-quarter" data-qa="number-at-level-{{ level.level }}">
                <p class="govuk-body govuk-!-margin-bottom-2">{{ level.levelDescription }}</p>
                <span class="govuk-body govuk-!-font-size-36 govuk-!-font-weight-bold">
                    {{ level.numberAtThisLevel | default(0) }}
                </span>
            </div>
        {% endfor %}
    </div>

    <p class="govuk-!-margin-top-9"></p>
    <h2 class="govuk-heading-l govuk-!-margin-top-9">
        Review dates and behaviour entries in the last 3 months
    </h2>

    {% macro table(level) %}
        {% set commonHeader = [
            {
                text: ""
            },
            {
                text: "Name and prison number"
            },
            {
                text: "Days on level"
            },
            {
                text: "Days since last review"
            },
            {
                text: "Positive behaviours"
            },
            {
                text: "Incentive encouragements"
            },
            {
                text: "Negative behaviours"
            },
            {
                text: "Incentive warnings"
            },
            {
                text: "Proven adjudications"
            }
        ] %}

        {% set rows = [] %}
        {% for prisoner in level.prisonerBehaviours %}
            {% if prisoner.imageId > 0 %}
                {% set imageUrl = '/prisoner-images/' + prisoner.imageId + '.jpeg' %}
            {% else %}
                {% set imageUrl = '/assets/images/prisoner.jpeg' %}
            {% endif %}

            {% set _ = rows.push([
            { html: '<img src="' + imageUrl + '" alt="' + prisoner.lastName + ', ' + prisoner.firstName + '\'s photo" width="90" />' },
            { html: '<a href="' + dpsHome + '/prisoner/' + prisoner.prisonerNumber + '/case-notes?fromDate=' + threeMonthsAgo | dateParam + '" class="govuk-link">' + prisoner.lastName + ', ' + prisoner.firstName + '<br>' + prisoner.prisonerNumber + '</a>' },
            { html: '<a href="' + dpsHome + '/prisoner/' + prisoner.prisonerNumber + '/incentive-level-details?agencyId=' + entries.prisonId + '" class="govuk-link">' + prisoner.daysOnLevel + '</a>' },
            { html: '<a href="' + dpsHome + '/prisoner/' + prisoner.prisonerNumber + '/incentive-level-details?agencyId=' + entries.prisonId + '" class="govuk-link">' + prisoner.daysSinceLastReview + '</a>' },
            { html: '<a href="' + dpsHome + '/prisoner/' + prisoner.prisonerNumber + '/case-notes?type=POS&fromDate=' + threeMonthsAgo | dateParam + '" class="govuk-link">' + prisoner.positiveBehaviours + '</a>' },
            { html: '<a href="' + dpsHome + '/prisoner/' + prisoner.prisonerNumber + '/case-notes?type=POS&subType=IEP_ENC&fromDate=' + threeMonthsAgo | dateParam + '" class="govuk-link">' + prisoner.incentiveEncouragements + '</a>' },
            { html: '<a href="' + dpsHome + '/prisoner/' + prisoner.prisonerNumber + '/case-notes?type=NEG&fromDate=' + threeMonthsAgo | dateParam + '" class="govuk-link">' + prisoner.negativeBehaviours + '</a>' },
            { html: '<a href="' + dpsHome + '/prisoner/' + prisoner.prisonerNumber + '/case-notes?type=NEG&subType=IEP_WARN&fromDate=' + threeMonthsAgo | dateParam + '" class="govuk-link">' + prisoner.incentiveWarnings + '</a>' },
            { html: '<a href="' + dpsHome + '/prisoner/' + prisoner.prisonerNumber + '/adjudications?finding=PROVED" class="govuk-link">' + prisoner.provenAdjudications + '</a>' }
            ]) %}
        {% endfor %}

        <h2 class="govuk-heading-l">{{ level.levelDescription }}</h2>
        {{ govukTable({
            head: commonHeader,
            rows: rows
        }) }}
    {% endmacro %}

    {% set tabsItems = [] %}
    {% for level in entries.incentiveLevelSummary %}
        {% set _ = tabsItems.push(
            {
                label: level.levelDescription,
                id: level.level,
                panel: { html: table(level) }
            }
        ) %}
    {% endfor %}

    {{ govukTabs({
        items: tabsItems
    }) }}

  </main>

{% endblock %}
