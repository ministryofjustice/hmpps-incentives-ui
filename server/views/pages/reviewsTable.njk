{% extends "../partials/layout.njk" %}
{% from "govuk/components/pagination/macro.njk" import govukPagination %}
{% from "govuk/components/table/macro.njk" import govukTable %}

{% set pageTitle = applicationName + " â€“ Manage incentive reviews" %}

{% block content %}
  <h1 class="govuk-heading-xl govuk-!-margin-bottom-4">
    Manage incentive reviews
  </h1>

  <p>
    <strong class="govuk-!-margin-right-3">{{ locationDescription }}</strong>
    <a href="/select-location">Select another location</a>
  </p>

  <dl class="app-data-list govuk-!-margin-top-6 govuk-!-margin-bottom-8">
    <dt>Overdue reviews</dt>
    <dd>
      {{- overdueCount -}}
    </dd>
  </dl>

  <h2 class="govuk-heading-l">Prisoner details and review status</h2>
  <ul class="govuk-tabs__list">
    {% for level in levels %}
      <li class="govuk-tabs__list-item {% if level.iepLevel == selectedLevelCode %}govuk-tabs__list-item--selected{% endif %}">
        <a class="govuk-tabs__tab" href="?level={{ level.iepLevel }}">
          {{ level.iepDescription }}
        </a>
      </li>
    {% endfor %}
  </ul>

  {% set tableRows = [] %}
  {% for review in reviews %}
    {% set photo %}
      {% if review.imageId > 0 %}
        {% set imageUrl = "/prisoner-images/" + prisoner.imageId + ".jpeg" %}
      {% else %}
        {% set imageUrl = "/assets/images/prisoner.jpeg" %}
      {% endif %}
      <img src="{{ imageUrl }}" alt="Photo of {{ review.prisonerNumber }}" />
    {% endset %}

    {% set profileLink %}
      <a href="{{ dpsUrl }}/prisoner/{{ review.prisonerNumber }}">
        {{ review.lastName }}, {{ review.firstName }}
        <br />
        {{ review.prisonerNumber }}
      </a>
    {% endset %}

    {% set nextReviewDate %}
      <strong>{{ review.nextReviewDate | shortDate }}</strong>
      {% set daysOverdue = review.nextReviewDate | daysSince %}
      {% if daysOverdue == 1 %}
        <br />
        <strong class="app-review-overdue">1 day overdue</strong>
      {% elif daysOverdue > 1 %}
        <br />
        <strong class="app-review-overdue">{{ daysOverdue }} days overdue</strong>
      {% endif %}
    {% endset %}

    {% set positiveBehaviours %}
      <a href="{{ dpsUrl }}/prisoner/{{ review.prisonerNumber }}/case-notes?type=POS&amp;{{ caseNoteFilter }}">
        {{ review.positiveBehaviours }}
      </a>
    {% endset %}

    {% set negativeBehaviours %}
      <a href="{{ dpsUrl }}/prisoner/{{ review.prisonerNumber }}/case-notes?type=NEG&amp;{{ caseNoteFilter }}">
        {{ review.negativeBehaviours }}
      </a>
    {% endset %}

    {% set tableRows = (tableRows.push([
      {html: photo},
      {html: profileLink},
      {html: nextReviewDate},
      {html: positiveBehaviours},
      {html: negativeBehaviours},
      {text: "ACCT open" if review.acctStatus else ""}
    ]), tableRows) %}
  {% endfor %}

  {{ govukTable({
    classes: "app-reviews-table",
    head: [
      {
        html: '<span class="govuk-visually-hidden">Prisoner photo</span>'
      },
      {
        text: "Name and prison number"
      },
      {
        text: "Date of next review"
      },
      {
        html: "Positive behaviours <br /> in the last 3 months"
      },
      {
        html: "Negative behaviours <br /> in the last 3 months"
      },
      {
        text: "ACCT status"
      }
    ],
    rows: tableRows
  }) }}

  <div class="app-reviews-pagination">
    {{ govukPagination(paginationParams) }}
  </div>
{% endblock %}
